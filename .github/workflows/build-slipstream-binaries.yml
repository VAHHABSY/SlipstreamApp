name: Build and Commit Slipstream Binaries

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/build-slipstream-binaries.yml'

jobs:
  build-slipstream:
    name: Build Slipstream Binaries
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout your SlipstreamApp repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Verify repository structure
        run: |
          mkdir -p app/src/main/jniLibs
          echo "âœ“ Directory structure verified"

      - name: Checkout slipstream-plugin-android
        uses: actions/checkout@v4
        with:
          repository: Mygod/slipstream-plugin-android
          submodules: recursive
          path: slipstream-plugin-android

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: armv7-linux-androideabi,aarch64-linux-android,i686-linux-android,x86_64-linux-android

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build python3 perl pkg-config

      - name: Set environment variables
        run: |
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang" >> $GITHUB_ENV
          echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi33-clang" >> $GITHUB_ENV
          echo "CARGO_TARGET_I686_LINUX_ANDROID_LINKER=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android33-clang" >> $GITHUB_ENV
          echo "CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android33-clang" >> $GITHUB_ENV
          echo "CC_aarch64_linux_android=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang" >> $GITHUB_ENV
          echo "CC_armv7_linux_androideabi=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi33-clang" >> $GITHUB_ENV
          echo "CC_i686_linux_android=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android33-clang" >> $GITHUB_ENV
          echo "CC_x86_64_linux_android=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android33-clang" >> $GITHUB_ENV
          echo "AR=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV
          echo "RANLIB=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib" >> $GITHUB_ENV

      - name: Build for ARM64
        working-directory: slipstream-plugin-android/app/src/main/rust/slipstream-rust
        run: |
          echo "=== Building for aarch64-linux-android ==="
          cargo build --release --target aarch64-linux-android \
            --bin slipstream-client \
            --features openssl-vendored,picoquic-minimal-build

      - name: Build for ARMv7
        working-directory: slipstream-plugin-android/app/src/main/rust/slipstream-rust
        run: |
          echo "=== Building for armv7-linux-androideabi ==="
          cargo build --release --target armv7-linux-androideabi \
            --bin slipstream-client \
            --features openssl-vendored,picoquic-minimal-build

      - name: Build for x86_64
        working-directory: slipstream-plugin-android/app/src/main/rust/slipstream-rust
        run: |
          echo "=== Building for x86_64-linux-android ==="
          cargo build --release --target x86_64-linux-android \
            --bin slipstream-client \
            --features openssl-vendored,picoquic-minimal-build

      - name: Build for x86
        working-directory: slipstream-plugin-android/app/src/main/rust/slipstream-rust
        run: |
          echo "=== Building for i686-linux-android ==="
          cargo build --release --target i686-linux-android \
            --bin slipstream-client \
            --features openssl-vendored,picoquic-minimal-build

      - name: Verify binaries
        working-directory: slipstream-plugin-android/app/src/main/rust/slipstream-rust
        run: |
          echo "=== Verifying binaries ==="
          ls -lh target/aarch64-linux-android/release/slipstream-client
          ls -lh target/armv7-linux-androideabi/release/slipstream-client
          ls -lh target/x86_64-linux-android/release/slipstream-client
          ls -lh target/i686-linux-android/release/slipstream-client

      - name: Copy binaries to jniLibs
        run: |
          mkdir -p app/src/main/jniLibs/{arm64-v8a,armeabi-v7a,x86_64,x86}
          
          cp slipstream-plugin-android/app/src/main/rust/slipstream-rust/target/aarch64-linux-android/release/slipstream-client \
             app/src/main/jniLibs/arm64-v8a/libslipstream.so
          
          cp slipstream-plugin-android/app/src/main/rust/slipstream-rust/target/armv7-linux-androideabi/release/slipstream-client \
             app/src/main/jniLibs/armeabi-v7a/libslipstream.so
          
          cp slipstream-plugin-android/app/src/main/rust/slipstream-rust/target/x86_64-linux-android/release/slipstream-client \
             app/src/main/jniLibs/x86_64/libslipstream.so
          
          cp slipstream-plugin-android/app/src/main/rust/slipstream-rust/target/i686-linux-android/release/slipstream-client \
             app/src/main/jniLibs/x86/libslipstream.so
          
          echo "âœ“ All binaries copied"

      - name: Strip binaries
        run: |
          STRIP="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
          
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            if [ -f "app/src/main/jniLibs/${abi}/libslipstream.so" ]; then
              "$STRIP" "app/src/main/jniLibs/${abi}/libslipstream.so"
              echo "âœ“ Stripped ${abi}"
              ls -lh "app/src/main/jniLibs/${abi}/libslipstream.so"
            fi
          done

      - name: Create README
        run: |
          cat > app/src/main/jniLibs/README.md << 'EOF'
          # Slipstream Android Native Libraries
          
          Built from: https://github.com/Mygod/slipstream-plugin-android
          
          ## Binary Sizes
          
          EOF
          echo '```' >> app/src/main/jniLibs/README.md
          ls -lh app/src/main/jniLibs/*/*.so >> app/src/main/jniLibs/README.md
          echo '```' >> app/src/main/jniLibs/README.md
          echo "" >> app/src/main/jniLibs/README.md
          echo "Built on: $(date -u)" >> app/src/main/jniLibs/README.md

      - name: Commit and push binaries
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add app/src/main/jniLibs/
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Update slipstream Android binaries

          Built on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            git push
            echo "âœ“ Binaries committed and pushed"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-android-binaries
          path: app/src/main/jniLibs/
          if-no-files-found: warn
