name: Build and Commit Slipstream Binaries

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/build-slipstream-binaries.yml'

jobs:
  build-slipstream:
    name: Build Slipstream Binaries
    runs-on: ubuntu-latest
    timeout-minutes: 120

    strategy:
      matrix:
        target:
          - rust_triple: aarch64-linux-android
            ndk_triple: aarch64-linux-android
            abi: arm64-v8a
            api: 33
          - rust_triple: armv7-linux-androideabi
            ndk_triple: armv7a-linux-androideabi
            abi: armeabi-v7a
            api: 33
          - rust_triple: x86_64-linux-android
            ndk_triple: x86_64-linux-android
            abi: x86_64
            api: 33
          - rust_triple: i686-linux-android
            ndk_triple: i686-linux-android
            abi: x86
            api: 33

    steps:
      - name: Checkout your SlipstreamApp repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Checkout slipstream-plugin-android
        uses: actions/checkout@v4
        with:
          repository: Mygod/slipstream-plugin-android
          submodules: recursive
          path: slipstream-plugin-android

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target.rust_triple }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build python3 perl pkg-config libssl-dev

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            slipstream-plugin-android/app/src/main/rust/slipstream-rust/target
          key: ${{ runner.os }}-cargo-${{ matrix.target.abi }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Set build environment for ${{ matrix.target.abi }}
        run: |
          NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
          CC_PATH="${NDK_TOOLCHAIN}/bin/${{ matrix.target.ndk_triple }}${{ matrix.target.api }}-clang"
          CXX_PATH="${NDK_TOOLCHAIN}/bin/${{ matrix.target.ndk_triple }}${{ matrix.target.api }}-clang++"
          AR_PATH="${NDK_TOOLCHAIN}/bin/llvm-ar"
          RANLIB_PATH="${NDK_TOOLCHAIN}/bin/llvm-ranlib"
          
          TARGET_UPPER=$(echo "${{ matrix.target.rust_triple }}" | tr '[:lower:]-' '[:upper:]_')
          
          echo "CARGO_TARGET_${TARGET_UPPER}_LINKER=${CC_PATH}" >> $GITHUB_ENV
          echo "CC_${{ matrix.target.rust_triple }}=${CC_PATH}" >> $GITHUB_ENV
          echo "CXX_${{ matrix.target.rust_triple }}=${CXX_PATH}" >> $GITHUB_ENV
          echo "AR_${{ matrix.target.rust_triple }}=${AR_PATH}" >> $GITHUB_ENV
          echo "RANLIB_${{ matrix.target.rust_triple }}=${RANLIB_PATH}" >> $GITHUB_ENV
          echo "CC=${CC_PATH}" >> $GITHUB_ENV
          echo "CXX=${CXX_PATH}" >> $GITHUB_ENV
          echo "AR=${AR_PATH}" >> $GITHUB_ENV
          echo "RANLIB=${RANLIB_PATH}" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "ANDROID_ABI=${{ matrix.target.abi }}" >> $GITHUB_ENV
          echo "ANDROID_PLATFORM=android-${{ matrix.target.api }}" >> $GITHUB_ENV
          echo "CMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake" >> $GITHUB_ENV
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV
          echo "OPENSSL_ROOT_DIR=/usr" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=/usr/include" >> $GITHUB_ENV
          echo "OPENSSL_CRYPTO_LIBRARY=/usr/lib/x86_64-linux-gnu/libcrypto.so" >> $GITHUB_ENV
          echo "OPENSSL_SSL_LIBRARY=/usr/lib/x86_64-linux-gnu/libssl.so" >> $GITHUB_ENV
          echo "BUILD_TESTING=OFF" >> $GITHUB_ENV

      - name: Build slipstream-client for ${{ matrix.target.abi }}
        working-directory: slipstream-plugin-android/app/src/main/rust/slipstream-rust
        run: |
          cargo build \
            --release \
            --target ${{ matrix.target.rust_triple }} \
            --bin slipstream-client \
            --features openssl-vendored,picoquic-minimal-build

      - name: Verify binary
        working-directory: slipstream-plugin-android/app/src/main/rust/slipstream-rust
        run: |
          BINARY="target/${{ matrix.target.rust_triple }}/release/slipstream-client"
          ls -lh "$BINARY"
          file "$BINARY"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-${{ matrix.target.abi }}
          path: slipstream-plugin-android/app/src/main/rust/slipstream-rust/target/${{ matrix.target.rust_triple }}/release/slipstream-client
          retention-days: 1

  package-and-commit:
    name: Package and Commit Binaries
    needs: build-slipstream
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: binaries

      - name: Setup Android NDK (for strip tool)
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true

      - name: Organize binaries into jniLibs
        run: |
          mkdir -p app/src/main/jniLibs/{arm64-v8a,armeabi-v7a,x86_64,x86}
          
          cp binaries/slipstream-arm64-v8a/slipstream-client app/src/main/jniLibs/arm64-v8a/libslipstream.so
          cp binaries/slipstream-armeabi-v7a/slipstream-client app/src/main/jniLibs/armeabi-v7a/libslipstream.so
          cp binaries/slipstream-x86_64/slipstream-client app/src/main/jniLibs/x86_64/libslipstream.so
          cp binaries/slipstream-x86/slipstream-client app/src/main/jniLibs/x86/libslipstream.so
          
          echo "âœ“ All binaries copied"

      - name: Strip binaries
        run: |
          STRIP="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
          
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            SIZE_BEFORE=$(stat -c%s "app/src/main/jniLibs/${abi}/libslipstream.so")
            "$STRIP" "app/src/main/jniLibs/${abi}/libslipstream.so"
            SIZE_AFTER=$(stat -c%s "app/src/main/jniLibs/${abi}/libslipstream.so")
            echo "âœ“ Stripped ${abi}: $(numfmt --to=iec $SIZE_BEFORE) â†’ $(numfmt --to=iec $SIZE_AFTER)"
          done

      - name: Create README
        run: |
          cat > app/src/main/jniLibs/README.md << 'EOF'
          # Slipstream Android Native Libraries
          
          Built from: https://github.com/Mygod/slipstream-plugin-android
          
          ## Binary Sizes
          
          EOF
          echo '```' >> app/src/main/jniLibs/README.md
          ls -lh app/src/main/jniLibs/*/*.so >> app/src/main/jniLibs/README.md
          echo '```' >> app/src/main/jniLibs/README.md
          echo "" >> app/src/main/jniLibs/README.md
          echo "Built on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> app/src/main/jniLibs/README.md

      - name: Create Pull Request with binaries
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ¤– Update slipstream Android binaries
            
            Built on: $(date -u)
            Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          branch: update-slipstream-binaries
          delete-branch: true
          title: 'ðŸ¤– Update Slipstream Android Binaries'
          body: |
            ## Automated Binary Update
            
            This PR updates the slipstream Android native binaries for all architectures.
            
            **Source:** https://github.com/Mygod/slipstream-plugin-android
            **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Built on:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            
            ### âœ… Architectures Included
            - arm64-v8a
            - armeabi-v7a
            - x86_64
            - x86
            
            ### ðŸ“¦ Files Added/Updated
            - `app/src/main/jniLibs/arm64-v8a/libslipstream.so`
            - `app/src/main/jniLibs/armeabi-v7a/libslipstream.so`
            - `app/src/main/jniLibs/x86_64/libslipstream.so`
            - `app/src/main/jniLibs/x86/libslipstream.so`
            - `app/src/main/jniLibs/README.md`
            
            Review and merge this PR to update the binaries in your app.
          labels: |
            automated
            dependencies
            native-libs

      - name: Create ZIP archive
        run: |
          cd app/src/main
          zip -r ../../../slipstream-android-jniLibs.zip jniLibs/
          cd ../../..
          sha256sum slipstream-android-jniLibs.zip > slipstream-android-jniLibs.zip.sha256

      - name: Upload final package
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-android-jniLibs
          path: |
            slipstream-android-jniLibs.zip
            slipstream-android-jniLibs.zip.sha256
          retention-days: 90
