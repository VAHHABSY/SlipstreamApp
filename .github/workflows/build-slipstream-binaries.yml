name: Build and Commit Slipstream Binaries

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/build-slipstream-binaries.yml'

jobs:
  build-slipstream:
    name: Build Slipstream Binaries
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout your SlipstreamApp repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Verify repository structure
        run: |
          echo "=== Repository Structure ==="
          ls -la
          mkdir -p app/src/main/jniLibs
          echo "âœ“ Directory structure verified"

      - name: Checkout slipstream-plugin-android
        uses: actions/checkout@v4
        with:
          repository: Mygod/slipstream-plugin-android
          submodules: recursive
          path: slipstream-plugin-android

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: armv7-linux-androideabi,aarch64-linux-android,i686-linux-android,x86_64-linux-android

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build python3 perl pkg-config

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('slipstream-plugin-android/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo build
        uses: actions/cache@v4
        with:
          path: slipstream-plugin-android/app/src/main/rust/slipstream-rust/target
          key: ${{ runner.os }}-cargo-target-${{ hashFiles('slipstream-plugin-android/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-

      - name: Patch NDK version to match installed version
        working-directory: slipstream-plugin-android
        run: |
          if [ -f "$ANDROID_NDK_HOME/source.properties" ]; then
            ACTUAL_NDK_VERSION=$(cat $ANDROID_NDK_HOME/source.properties | grep 'Pkg.Revision' | cut -d'=' -f2 | tr -d ' \r\n')
            echo "Found installed NDK version: $ACTUAL_NDK_VERSION"
          else
            echo "âŒ ERROR: source.properties not found in NDK"
            exit 1
          fi
          
          echo ""
          echo "=== Original build.gradle.kts ndkVersion ==="
          grep -n "ndkVersion" app/build.gradle.kts || echo "ndkVersion line not found"
          
          if grep -q "ndkVersion" app/build.gradle.kts; then
            sed -i "s/ndkVersion = \"[^\"]*\"/ndkVersion = \"$ACTUAL_NDK_VERSION\"/" app/build.gradle.kts
            echo ""
            echo "=== Updated build.gradle.kts ndkVersion ==="
            grep -n "ndkVersion" app/build.gradle.kts
            echo ""
            echo "âœ“ NDK version updated successfully"
          else
            echo "âš ï¸  Warning: ndkVersion line not found"
          fi

      - name: Set NDK environment variables
        run: |
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV

      - name: Create local.properties
        working-directory: slipstream-plugin-android
        run: |
          echo "sdk.dir=$ANDROID_HOME" > local.properties
          echo "ndk.dir=$ANDROID_NDK_HOME" >> local.properties
          cat local.properties

      - name: Grant execute permission to gradlew
        working-directory: slipstream-plugin-android
        run: chmod +x gradlew

      - name: Check build environment
        run: |
          echo "=== System Information ==="
          echo "CPU cores: $(nproc)"
          free -h
          df -h /
          echo ""
          echo "=== Rust Information ==="
          rustc --version
          cargo --version
          rustup show
          echo ""
          echo "=== Environment ==="
          env | grep -E "ANDROID|NDK|RUST|CARGO" | sort

      - name: Build Slipstream binaries
        working-directory: slipstream-plugin-android
        run: |
          echo "=== Starting Rust build for Android ==="
          echo "This will take 15-30 minutes..."
          echo ""
          
          set +e
          ./gradlew cargoBuild 2>&1 | tee build.log
          BUILD_EXIT_CODE=$?
          set -e
          
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "âŒ BUILD FAILED with exit code $BUILD_EXIT_CODE"
            echo ""
            echo "=== ERROR messages ==="
            grep -i "error" build.log | tail -30 || echo "No error messages"
            echo ""
            echo "=== FAILED messages ==="
            grep -i "failed" build.log | tail -20 || echo "No failed messages"
            echo ""
            echo "=== Last 80 lines of output ==="
            tail -n 80 build.log
            echo ""
            echo "=== Checking for partial binaries ==="
            find . -name "slipstream-client" -type f 2>/dev/null || echo "None found"
            exit 1
          fi
          
          echo "âœ“ Build completed successfully"

      - name: Verify all binaries were built
        working-directory: slipstream-plugin-android
        run: |
          echo "=== Verifying binaries ==="
          MISSING=0
          
          for target in "aarch64-linux-android:arm64-v8a" "armv7-linux-androideabi:armeabi-v7a" "x86_64-linux-android:x86_64" "i686-linux-android:x86"; do
            IFS=':' read -r rust_target abi <<< "$target"
            
            if [ -f "app/src/main/rust/slipstream-rust/target/${rust_target}/release/slipstream-client" ] || \
               [ -f "app/src/main/rust/slipstream-rust/target/${rust_target}/debug/slipstream-client" ]; then
              echo "âœ“ Found ${abi}"
            else
              echo "âŒ Missing ${abi}"
              MISSING=$((MISSING + 1))
            fi
          done
          
          if [ $MISSING -gt 0 ]; then
            echo "âŒ $MISSING architectures failed"
            exit 1
          fi
          
          echo "âœ“ All binaries built"

      - name: Create jniLibs directory
        run: |
          mkdir -p app/src/main/jniLibs/{arm64-v8a,armeabi-v7a,x86_64,x86}

      - name: Copy binaries
        run: |
          copy_binary() {
            local target=$1
            local abi=$2
            
            if [ -f "slipstream-plugin-android/app/src/main/rust/slipstream-rust/target/${target}/release/slipstream-client" ]; then
              cp "slipstream-plugin-android/app/src/main/rust/slipstream-rust/target/${target}/release/slipstream-client" \
                 "app/src/main/jniLibs/${abi}/libslipstream.so"
              echo "âœ“ Copied ${abi} (release)"
              return 0
            elif [ -f "slipstream-plugin-android/app/src/main/rust/slipstream-rust/target/${target}/debug/slipstream-client" ]; then
              cp "slipstream-plugin-android/app/src/main/rust/slipstream-rust/target/${target}/debug/slipstream-client" \
                 "app/src/main/jniLibs/${abi}/libslipstream.so"
              echo "âœ“ Copied ${abi} (debug)"
              return 0
            else
              echo "âŒ Failed ${abi}"
              return 1
            fi
          }
          
          copy_binary "aarch64-linux-android" "arm64-v8a"
          copy_binary "armv7-linux-androideabi" "armeabi-v7a"
          copy_binary "x86_64-linux-android" "x86_64"
          copy_binary "i686-linux-android" "x86"

      - name: Strip binaries
        run: |
          STRIP="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            [ -f "app/src/main/jniLibs/${abi}/libslipstream.so" ] && "$STRIP" "app/src/main/jniLibs/${abi}/libslipstream.so" && echo "âœ“ Stripped ${abi}"
          done

      - name: Create README
        run: |
          cat > app/src/main/jniLibs/README.md << 'EOF'
          # Slipstream Android Binaries
          
          Built from: https://github.com/Mygod/slipstream-plugin-android
          EOF
          echo "Built: $(date -u)" >> app/src/main/jniLibs/README.md
          ls -lh app/src/main/jniLibs/*/*.so >> app/src/main/jniLibs/README.md

      - name: Commit binaries
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add app/src/main/jniLibs/
          git diff --cached --quiet || git commit -m "ðŸ¤– Update slipstream binaries" && git push

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-binaries
          path: app/src/main/jniLibs/
          if-no-files-found: warn
