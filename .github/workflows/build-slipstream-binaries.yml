name: Build and Commit Slipstream Binaries

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/build-slipstream-binaries.yml'

jobs:
  build-slipstream:
    name: Build Slipstream Binaries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your SlipstreamApp repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout slipstream-plugin-android
        uses: actions/checkout@v4
        with:
          repository: Mygod/slipstream-plugin-android
          submodules: recursive
          path: slipstream-plugin-android

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27.2.12479018
          add-to-path: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: armv7-linux-androideabi,aarch64-linux-android,i686-linux-android,x86_64-linux-android

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build python3 perl pkg-config

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('slipstream-plugin-android/**/Cargo.lock') }}

      - name: Cache Cargo build
        uses: actions/cache@v4
        with:
          path: slipstream-plugin-android/app/src/main/rust/slipstream-rust/target
          key: ${{ runner.os }}-cargo-target-${{ hashFiles('slipstream-plugin-android/**/Cargo.lock') }}

      - name: Build Slipstream binaries
        working-directory: slipstream-plugin-android
        run: |
          chmod +x gradlew
          
          echo "=== Starting Rust build for Android ==="
          ./gradlew cargoBuild
          
          echo ""
          echo "=== Build completed ==="
          echo "Checking for built binaries..."
          find app/src/main/rust/slipstream-rust/target -name "slipstream-client" -type f

      - name: Create jniLibs directory structure
        run: |
          mkdir -p app/src/main/jniLibs/arm64-v8a
          mkdir -p app/src/main/jniLibs/armeabi-v7a
          mkdir -p app/src/main/jniLibs/x86_64
          mkdir -p app/src/main/jniLibs/x86

      - name: Copy and process binaries
        run: |
          echo "=== Copying binaries to jniLibs ==="
          
          # Function to copy binary (try release first, fall back to debug)
          copy_binary() {
            local target=$1
            local abi=$2
            
            if [ -f "slipstream-plugin-android/app/src/main/rust/slipstream-rust/target/${target}/release/slipstream-client" ]; then
              cp "slipstream-plugin-android/app/src/main/rust/slipstream-rust/target/${target}/release/slipstream-client" \
                 "app/src/main/jniLibs/${abi}/libslipstream.so"
              echo "âœ“ Copied ${abi} (release)"
            elif [ -f "slipstream-plugin-android/app/src/main/rust/slipstream-rust/target/${target}/debug/slipstream-client" ]; then
              cp "slipstream-plugin-android/app/src/main/rust/slipstream-rust/target/${target}/debug/slipstream-client" \
                 "app/src/main/jniLibs/${abi}/libslipstream.so"
              echo "âœ“ Copied ${abi} (debug)"
            else
              echo "âœ— Failed to find ${abi} binary"
              return 1
            fi
          }
          
          copy_binary "aarch64-linux-android" "arm64-v8a"
          copy_binary "armv7-linux-androideabi" "armeabi-v7a"
          copy_binary "x86_64-linux-android" "x86_64"
          copy_binary "i686-linux-android" "x86"
          
          echo ""
          echo "=== Stripping debug symbols ==="
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            if [ -f "app/src/main/jniLibs/${abi}/libslipstream.so" ]; then
              $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
                "app/src/main/jniLibs/${abi}/libslipstream.so"
              echo "âœ“ Stripped ${abi}"
            fi
          done

      - name: Verify binaries
        run: |
          echo "=== Binary Information ==="
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            if [ -f "app/src/main/jniLibs/${abi}/libslipstream.so" ]; then
              echo ""
              echo "Architecture: ${abi}"
              file "app/src/main/jniLibs/${abi}/libslipstream.so"
              ls -lh "app/src/main/jniLibs/${abi}/libslipstream.so"
            fi
          done

      - name: Create/Update README in jniLibs
        run: |
          cat > app/src/main/jniLibs/README.md << 'EOF'
          # Slipstream Android Native Libraries
          
          These binaries are automatically built from: https://github.com/Mygod/slipstream-plugin-android
          
          ## Build Information
          
          EOF
          
          echo "Built on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> app/src/main/jniLibs/README.md
          echo "Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> app/src/main/jniLibs/README.md
          echo "" >> app/src/main/jniLibs/README.md
          echo "## Binary Sizes" >> app/src/main/jniLibs/README.md
          echo '```' >> app/src/main/jniLibs/README.md
          ls -lh app/src/main/jniLibs/*/*.so 2>/dev/null >> app/src/main/jniLibs/README.md || echo "No binaries found" >> app/src/main/jniLibs/README.md
          echo '```' >> app/src/main/jniLibs/README.md
          
          echo "" >> app/src/main/jniLibs/README.md
          cat >> app/src/main/jniLibs/README.md << 'EOF'
          
          ## Usage in Your App
          
          The binaries are automatically loaded by Android from the correct architecture folder.
          
          ```kotlin
          val nativeLibDir = applicationInfo.nativeLibraryDir
          val binaryPath = File(nativeLibDir, "libslipstream.so").absolutePath
          
          val process = ProcessBuilder(
              binaryPath,
              "domain.com",
              "1.1.1.1",
              "--socks-port",
              "1081"
          ).start()
          ```
          EOF
          
          cat app/src/main/jniLibs/README.md

      - name: Check for changes
        id: git-check
        run: |
          git diff --quiet app/src/main/jniLibs/ || echo "changes=true" >> $GITHUB_OUTPUT
          
          if [ -n "$(git status --porcelain app/src/main/jniLibs/)" ]; then
            echo "Changes detected in jniLibs"
            git status app/src/main/jniLibs/
          else
            echo "No changes in jniLibs"
          fi

      - name: Commit and push binaries
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add app/src/main/jniLibs/
          git commit -m "ðŸ¤– Auto-update slipstream binaries

          - Built from Mygod/slipstream-plugin-android
          - Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          git push

      - name: Create backup archive
        run: |
          zip -r slipstream-binaries-backup.zip app/src/main/jniLibs/
          sha256sum slipstream-binaries-backup.zip > slipstream-binaries-backup.zip.sha256

      - name: Upload backup artifacts
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-binaries-backup
          path: |
            slipstream-binaries-backup.zip
            slipstream-binaries-backup.zip.sha256
          retention-days: 30

      - name: Summary
        run: |
          echo "## âœ… Slipstream Binaries Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Binary Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | Size | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            if [ -f "app/src/main/jniLibs/${abi}/libslipstream.so" ]; then
              size=$(ls -lh "app/src/main/jniLibs/${abi}/libslipstream.so" | awk '{print $5}')
              echo "| ${abi} | ${size} | âœ… Built |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ${abi} | - | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.git-check.outputs.changes }}" == "true" ]; then
            echo "### ðŸŽ‰ Binaries committed to repository" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The binaries have been automatically committed to \`app/src/main/jniLibs/\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No changes detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The binaries are identical to the existing ones." >> $GITHUB_STEP_SUMMARY
          fi
